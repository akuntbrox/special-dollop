-- // Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local localPlayer = Players.LocalPlayer

-- // Rayfield UI (auto-load & config saving)
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

local Window = Rayfield:CreateWindow({
    Name = "Follow Controller",
    LoadingTitle = "Follow Script",
    LoadingSubtitle = "Rayfield UI",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "FollowScriptConfigs", -- change if you want a different folder
        FileName = "FollowSettings"
    },
    Discord = {
        Enabled = false,
        Invite = "",
        RememberJoins = false
    },
    KeySystem = false
})

--------------------------------------------------------
-- PLACE / LOBBY
--------------------------------------------------------

local LOBBY_PLACE_ID = 88043900517876
local IS_LOBBY = (game.PlaceId == LOBBY_PLACE_ID)

--------------------------------------------------------
-- CONFIG
--------------------------------------------------------

-- default value, can be changed from Rayfield input
local TARGET_USERNAME = "-"

local STOP_DISTANCE = 4                 -- stop when too close to target
local FOLLOW_SPEED  = 16.24             -- follower WalkSpeed

local PROXIMITY_DETECTION_RADIUS = 4    -- prompt detection radius (non-lobby)
local INTERACT_COOLDOWN = 1             -- seconds between same prompt interactions

-- Portal-specific config
local PORTAL_DELAY_BEFORE_USE = 2       -- wait 2s before using a portal
local MIN_MOVE_AFTER_PORTAL = 20        -- must move this many studs after a portal
                                        -- before any next Portal can auto-fire

-- Run / walk animation (R15)
local RUN_ANIMATION_ID = 507767714      -- your chosen walk/run animation asset id

--------------------------------------------------------
-- INTERNAL STATE
--------------------------------------------------------

local proximityPrompts = {}
local isNearPrompt = false

local lastInteractedPrompt = nil
local lastInteractTime = 0

local lastRootPos = nil
local distanceMovedSincePortal = 0      -- how far weâ€™ve moved since last portal use

local followEnabled = true              -- controlled by Rayfield toggle

--------------------------------------------------------
-- RUN / WALK ANIMATION HANDLER (hooked via Humanoid.Running)
--------------------------------------------------------

local runTrack = nil
local runAnim = nil

local function setupRunAnimation(humanoid)
    if not humanoid then return end
    if RUN_ANIMATION_ID == 0 then return end

    -- This ID is R15, so skip R6 to avoid weirdness
    if humanoid.RigType == Enum.HumanoidRigType.R6 then
        return
    end

    local animator = humanoid:FindFirstChildOfClass("Animator")
    if not animator then
        animator = Instance.new("Animator")
        animator.Parent = humanoid
    end

    if not runAnim then
        runAnim = Instance.new("Animation")
        runAnim.AnimationId = "rbxassetid://" .. RUN_ANIMATION_ID
    end

    -- already loaded on this animator?
    if runTrack and runTrack.Parent == animator then
        return
    end

    runTrack = animator:LoadAnimation(runAnim)
    runTrack.Priority = Enum.AnimationPriority.Movement
    runTrack.Looped = true
end

local function playRunAnimation(humanoid)
    setupRunAnimation(humanoid)
    if runTrack and not runTrack.IsPlaying then
        runTrack:Play()
    end
end

local function stopRunAnimation()
    if runTrack and runTrack.IsPlaying then
        runTrack:Stop()
    end
end

-- Hook Humanoid.Running so animation follows actual movement
local function hookHumanoidRunning(char)
    runTrack = nil

    local humanoid = char:FindFirstChildOfClass("Humanoid")
    if not humanoid then
        humanoid = char:WaitForChild("Humanoid", 5)
    end
    if not humanoid then return end

    humanoid.Running:Connect(function(speed)
        -- If follow is off, do not play custom walk
        if not followEnabled then
            stopRunAnimation()
            return
        end

        if speed > 0.1 then
            playRunAnimation(humanoid)
        else
            stopRunAnimation()
        end
    end)
end

localPlayer.CharacterAdded:Connect(hookHumanoidRunning)
if localPlayer.Character then
    hookHumanoidRunning(localPlayer.Character)
end

--------------------------------------------------------
-- RAYFIELD UI: TAB + INPUT + TOGGLE
--------------------------------------------------------

local MainTab = Window:CreateTab("Main", 4483362458) -- icon id optional

-- Username input
local UsernameInput = MainTab:CreateInput({
    Name = "Target Username",
    CurrentValue = TARGET_USERNAME,
    PlaceholderText = "Enter username to follow",
    RemoveTextAfterFocusLost = false,
    Flag = "Follow_Target_Username", -- saved in config
    Callback = function(Text)
        if Text ~= "" then
            TARGET_USERNAME = Text
        end
    end,
})

-- Follow toggle
local FollowToggle = MainTab:CreateToggle({
    Name = "Follow Enabled",
    CurrentValue = true,
    Flag = "Follow_Enabled", -- saved in config
    Callback = function(Value)
        followEnabled = Value
        if not followEnabled then
            stopRunAnimation()
        end
    end,
})

-- Optional: show some info
MainTab:CreateParagraph({
    Title = "Info",
    Content = "Enter a username in this server and toggle Follow ON.\nScript will auto-use saved settings next time."
})

--------------------------------------------------------
-- HELPERS
--------------------------------------------------------

local function getTarget()
    return Players:FindFirstChild(TARGET_USERNAME)
end

local function registerPrompt(prompt)
    if prompt:IsA("ProximityPrompt") then
        table.insert(proximityPrompts, prompt)
    end
end

-- Optional: full path helper for debugging
local function getFullPath(instance)
    local path = instance.Name
    local parent = instance.Parent

    while parent do
        path = parent.Name .. "." .. path
        parent = parent.Parent
    end

    return path
end

--------------------------------------------------------
-- PROXIMITY PROMPT SETUP (only if NOT in lobby)
--------------------------------------------------------

if not IS_LOBBY then
    -- existing prompts
    for _, desc in ipairs(Workspace:GetDescendants()) do
        if desc:IsA("ProximityPrompt") then
            registerPrompt(desc)
        end
    end

    -- new prompts
    Workspace.DescendantAdded:Connect(function(desc)
        if desc:IsA("ProximityPrompt") then
            registerPrompt(desc)
        end
    end)
end

local function checkForNearbyPrompt(rootPart)
    local closestDist = math.huge
    local closestPrompt = nil

    for i = #proximityPrompts, 1, -1 do
        local prompt = proximityPrompts[i]

        if not prompt or not prompt.Parent then
            table.remove(proximityPrompts, i)
        else
            if prompt.Enabled then
                local promptPart = prompt.Parent
                if not promptPart:IsA("BasePart") then
                    promptPart = prompt.Parent:FindFirstChildWhichIsA("BasePart")
                end

                if promptPart then
                    local dist = (promptPart.Position - rootPart.Position).Magnitude
                    if dist < closestDist then
                        closestDist = dist
                        closestPrompt = prompt
                    end
                end
            end
        end
    end

    if closestPrompt and closestDist <= PROXIMITY_DETECTION_RADIUS then
        return true, closestPrompt, closestDist
    else
        return false, nil, closestDist
    end
end

--------------------------------------------------------
-- MAIN LOOP
--------------------------------------------------------

RunService.Heartbeat:Connect(function()
    local char = localPlayer.Character
    if not char then
        stopRunAnimation()
        return
    end

    local humanoid = char:FindFirstChildOfClass("Humanoid")
    local root = char:FindFirstChild("HumanoidRootPart")
    if not humanoid or not root then
        stopRunAnimation()
        return
    end

    humanoid.WalkSpeed = FOLLOW_SPEED

    --------------------------------------------------------
    -- If follow is disabled from UI, just stop movement
    --------------------------------------------------------
    if not followEnabled then
        humanoid:Move(Vector3.new())
        return
    end

    --------------------------------------------------------
    -- UPDATE MOVEMENT DISTANCE SINCE LAST PORTAL
    --------------------------------------------------------
    if lastRootPos then
        local delta = (root.Position - lastRootPos).Magnitude
        distanceMovedSincePortal = distanceMovedSincePortal + delta
    end
    lastRootPos = root.Position

    local skipFollow = false

    --------------------------------------------------------
    -- 1) PROXIMITYPROMPT (disabled in lobby)
    --------------------------------------------------------
    if not IS_LOBBY then
        local nearPrompt, prompt = checkForNearbyPrompt(root)
        isNearPrompt = nearPrompt

        if isNearPrompt and prompt then
            local parentName = prompt.Parent and prompt.Parent.Name or "?"
            local now = os.clock()
            local isPortal = (parentName == "Portal")

            ------------------------------------------------
            -- PORTAL GUARD
            ------------------------------------------------
            if isPortal and distanceMovedSincePortal < MIN_MOVE_AFTER_PORTAL then
                -- ignore this portal for now
            else
                if prompt ~= lastInteractedPrompt or (now - lastInteractTime) > INTERACT_COOLDOWN then
                    lastInteractedPrompt = prompt
                    lastInteractTime = now

                    -- Stop movement while interacting
                    humanoid:Move(Vector3.new())
                    skipFollow = true

                    task.spawn(function()
                        if isPortal then
                            task.wait(PORTAL_DELAY_BEFORE_USE)
                            distanceMovedSincePortal = 0
                        end

                        if prompt.HoldDuration == 0 then
                            prompt:InputHoldBegin()
                            prompt:InputHoldEnd()
                        else
                            prompt:InputHoldBegin()
                            task.wait(prompt.HoldDuration)
                            prompt:InputHoldEnd()
                        end
                    end)
                end
            end
        end
    else
        isNearPrompt = false
    end

    if skipFollow then
        return
    end

    --------------------------------------------------------
    -- 2) FOLLOW TARGET USING MOVETO
    --------------------------------------------------------
    local target = getTarget()
    if not target or not target.Character then
        humanoid:Move(Vector3.new())
        return
    end

    local targetChar = target.Character
    local targetHum = targetChar:FindFirstChildOfClass("Humanoid")
    local targetRoot = targetChar:FindFirstChild("HumanoidRootPart")
    if not targetHum or not targetRoot then
        humanoid:Move(Vector3.new())
        return
    end

    local distance = (targetRoot.Position - root.Position).Magnitude

    -- if too close, stop
    if distance <= STOP_DISTANCE then
        humanoid:Move(Vector3.new())
        return
    end

    humanoid:MoveTo(targetRoot.Position)
    -- animation handled by Humanoid.Running
end)
