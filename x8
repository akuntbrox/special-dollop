local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local AttackEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("AttackV2")

-- Konfigurasi Awal
_G.AutoAttackEnabled = false
_G.SpeedEnabled = false
_G.SpeedMultiplier = 1
local BASE_SPEED = 16
local ATTACK_RANGE = 200
local ATTACK_SPEED = 0.01
local UI_WIDTH = 200
local UI_HEIGHT = 180

-- 1. Fungsi Filter Musuh yang Ditingkatkan (Mendeteksi Nama NPC)
local function isValidEnemy(target)
    if target and target:FindFirstChild("Humanoid") and target.Humanoid.Health > 0 then
        local targetName = target.Name:lower()
        local isNPCAttr = target:GetAttribute("IsNPC")
        local mobLevel = target:GetAttribute("MobLevel")
        
        -- Filter 1: Cek apakah namanya mengandung kata "npc"
        if targetName:find("npc") or targetName:find("%(npc%)") then
            return false
        end

        -- Filter 2: Hanya serang jika memiliki MobLevel dan bukan atribut NPC
        if isNPCAttr ~= true and mobLevel ~= nil then
            -- Filter 3: Hindari kayu dummy
            if not targetName:find("wood") and not targetName:find("dummy") then
                return true
            end
        end
    end
    return false
end

-- 2. GUI Draggable
local function CreateUI()
    local parent = CoreGui or LocalPlayer:WaitForChild("PlayerGui")
    if parent:FindFirstChild("MageNPC_Filter_GUI") then parent.MageNPC_Filter_GUI:Destroy() end

    local sg = Instance.new("ScreenGui", parent); sg.Name = "MageNPC_Filter_GUI"; sg.ResetOnSpawn = false
    local main = Instance.new("Frame", sg)
    main.Size = UDim2.new(0, UI_WIDTH, 0, UI_HEIGHT); main.Position = UDim2.new(0.5, -UI_WIDTH / 2, 0.2, 0)
    main.BackgroundColor3 = Color3.fromRGB(35, 35, 35); main.Active = true; main.Draggable = true 

    local header = Instance.new("TextLabel", main)
    header.Size = UDim2.new(1, -45, 0, 30); header.Position = UDim2.new(0, 10, 0, 5)
    header.Text = "Mage Control"; header.TextColor3 = Color3.new(1, 1, 1)
    header.TextXAlignment = Enum.TextXAlignment.Left; header.BackgroundTransparency = 1
    header.Font = Enum.Font.SourceSansBold; header.TextSize = 18

    local minimizeBtn = Instance.new("TextButton", main)
    minimizeBtn.Size = UDim2.new(0, 30, 0, 25); minimizeBtn.Position = UDim2.new(1, -35, 0, 7)
    minimizeBtn.Text = "-"; minimizeBtn.TextColor3 = Color3.new(1, 1, 1)
    minimizeBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)

    local atkBtn = Instance.new("TextButton", main)
    atkBtn.Size = UDim2.new(1, -20, 0, 40); atkBtn.Position = UDim2.new(0, 10, 0, 40)
    atkBtn.Text = "AUTO ATTACK: OFF"; atkBtn.BackgroundColor3 = Color3.fromRGB(150, 0, 0); atkBtn.TextColor3 = Color3.new(1, 1, 1)

    local speedBtn = Instance.new("TextButton", main)
    speedBtn.Size = UDim2.new(1, -20, 0, 40); speedBtn.Position = UDim2.new(0, 10, 0, 85)
    speedBtn.Text = "SPEED: OFF"; speedBtn.BackgroundColor3 = Color3.fromRGB(150, 0, 0); speedBtn.TextColor3 = Color3.new(1, 1, 1)

    local label = Instance.new("TextLabel", main)
    label.Size = UDim2.new(1, 0, 0, 20); label.Position = UDim2.new(0, 0, 0, 135)
    label.Text = "SPEED: 1x"; label.TextColor3 = Color3.new(1, 1, 1); label.BackgroundTransparency = 1

    local adjBtn = Instance.new("TextButton", main)
    adjBtn.Size = UDim2.new(1, -20, 0, 30); adjBtn.Position = UDim2.new(0, 10, 0, 155)
    adjBtn.Text = "SET SPEED (1-5x)"; adjBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60); adjBtn.TextColor3 = Color3.new(1, 1, 1)

    local isMinimized = false
    local content = {atkBtn, speedBtn, label, adjBtn}
    local function updateMinimizeState()
        for _, element in ipairs(content) do
            element.Visible = not isMinimized
        end
        main.Size = isMinimized and UDim2.new(0, UI_WIDTH, 0, 40) or UDim2.new(0, UI_WIDTH, 0, UI_HEIGHT)
        minimizeBtn.Text = isMinimized and "+" or "-"
    end
    minimizeBtn.MouseButton1Click:Connect(function()
        isMinimized = not isMinimized
        updateMinimizeState()
    end)
    updateMinimizeState()

    atkBtn.MouseButton1Click:Connect(function()
        _G.AutoAttackEnabled = not _G.AutoAttackEnabled
        atkBtn.Text = _G.AutoAttackEnabled and "AUTO ATK: ON" or "AUTO ATK: OFF"
        atkBtn.BackgroundColor3 = _G.AutoAttackEnabled and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(150, 0, 0)
    end)

    speedBtn.MouseButton1Click:Connect(function()
        _G.SpeedEnabled = not _G.SpeedEnabled
        speedBtn.Text = _G.SpeedEnabled and "SPEED: ON" or "SPEED: OFF"
        speedBtn.BackgroundColor3 = _G.SpeedEnabled and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(150, 0, 0)
    end)

    adjBtn.MouseButton1Click:Connect(function()
        _G.SpeedMultiplier = _G.SpeedMultiplier + 1
        if _G.SpeedMultiplier > 5 then _G.SpeedMultiplier = 1 end
        label.Text = "SPEED: " .. _G.SpeedMultiplier .. "x"
    end)
end

-- 3. Loop Serangan Utama
task.spawn(function()
    while true do
        if _G.AutoAttackEnabled then
            local char = LocalPlayer.Character
            local root = char and char:FindFirstChild("HumanoidRootPart")

            if root and workspace:FindFirstChild("Characters") then
                for _, enemy in pairs(workspace.Characters:GetChildren()) do
                    if isValidEnemy(enemy) then
                        local enemyRoot = enemy:FindFirstChild("HumanoidRootPart")
                        if enemyRoot then
                            local distance = (root.Position - enemyRoot.Position).Magnitude
                            if distance <= ATTACK_RANGE then
                                -- Argumen serangan Mage sesuai log
                                AttackEvent:FireServer(5, 1, enemy)
                            end
                        end
                    end
                end
            end
        end
        task.wait(ATTACK_SPEED)
    end
end)

-- 4. Loop Speed Modifier
RunService.Stepped:Connect(function()
    local hum = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid")
    if hum then
        hum.WalkSpeed = _G.SpeedEnabled and (BASE_SPEED * _G.SpeedMultiplier) or BASE_SPEED
    end
end)

CreateUI()
